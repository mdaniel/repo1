name: autobots, roll out

on:
  workflow_dispatch:
  push:
    branches:
    # -> dev automagically
    - main
    # the other branches are covered under the "workflow_dispatch:"
    # and then picking the branch

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sniff-it:
    runs-on: ubuntu-latest
    name: dynamic information
    outputs:
      the_url: ${{ steps.the-url.outputs.the_url }}
    steps:
    - name: foo
      id: the-url
      run: echo "the_url=https://${{ github.ref_name }}.example.com" > $GITHUB_OUTPUT

  deploy-it:
    needs:
    - sniff-it
    runs-on: ubuntu-latest
    permissions: write-all
    name: deploy to ${{ github.ref_name }}
    environment:
      # we could obviously cook this in the prior job, too
      name: env/${{ (github.ref == 'refs/heads/main') && 'dev' || github.ref_name }}
      url: ${{ needs.sniff-it.outputs.the_url }}
    steps:
    - name: doit
      shell: bash
      env:
        EKS_ARN: ${{ vars.EKS_ARN }}
        # dumb
        GH_TOKEN: ${{ github.token }}
      run: |
        cat <<"FOO"
        ${{ toJSON(github.event) }}
        FOO
        echo "currently ${{ runner.environment }} into ${EKS_ARN}"
        if ! gh api --verbose \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          /repos/mdaniel/repo1/deployments
        then
          echo "Welp, not like that I guess RC=$?" >&2
        fi
